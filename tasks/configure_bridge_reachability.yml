---
- name: ensure /data/bridge_reachability exists
  file: >
    path=/data/bridge_reachability
    owner="{{ ooni_user }}"
    group="{{ ooni_user }}"
    state="directory"
    mode=0644
  sudo: yes

- name: ensure ~/.ooni/ exists
  file: >
    path={{ ooni_home }}/.ooni
    owner="{{ ooni_user }}"
    group="{{ ooni_user }}"
    state="directory"
    mode=0644

- name: ensure templated ooniprobe.conf is installed
  template: >
    src=ooniprobe.conf
    dest="{{ ooni_home }}/.ooni/ooniprobe.conf"
    owner={{ ooni_user }}
    mode=0644

- name: write list of bridges to test
  copy: >
    src=bridges.txt
    dest=/data/bridge_reachability/bridges.txt
    owner="{{ ooni_user }}"
    group="{{ ooni_user }}"
    mode=0644

- cron: >
    name="bridge_reachability"
    user="{{ ooni_user }}"
    minute="0"
    hour="0"
    job="/usr/local/bin/ooniprobe -c {{ ooni_collector }} blocking/bridge_reachability -f /data/bridge_reachability/bridges.txt -t 400"
  when: ooni_cron_bridge_reachability == True
